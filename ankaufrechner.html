<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Geräte-Ankaufspreisrechner</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 750px;
      margin: auto;
      padding: 20px;
    }
    label, select {
      display: block;
      margin: 10px 0;
    }
    .defects {
      margin-top: 15px;
      padding-left: 15px;
    }
    .result {
      margin-top: 20px;
      font-size: 1.4em;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Ankaufspreis-Rechner</h1>

  <label for="brand">Marke:</label>
  <select id="brand" onchange="populateModels()">
    <option value="">Bitte wählen</option>
    <option value="Apple">Apple</option>
    <option value="Samsung">Samsung</option>
  </select>

  <label for="model">Modell:</label>
  <select id="model"></select>

  <label for="storage">Speichergröße:</label>
  <select id="storage"></select>

  <label for="condition">Zustand:</label>
  <select id="condition">
    <option value="1.0">Wie neu</option>
    <option value="0.9">Gut</option>
    <option value="0.75">Gebraucht</option>
    <option value="0.4">Stark gebraucht</option>
  </select>

  <div class="defects" id="defectList">
    <strong>Defekte Komponenten:</strong><br>
    (CSV wird geladen…)
  </div>

  <button onclick="calculatePrice()">Preis berechnen</button>

  <div class="result" id="priceResult">CSV wird geladen…</div>

  <script>
    let priceData = [];
    let defectData = [];

    Papa.parse("preise.csv", {
      download: true,
      header: true,
      complete: function(results) {
        priceData = results.data;
        populateModels();
      }
    });

    Papa.parse("defekte.csv", {
      download: true,
      header: true,
      complete: function(results) {
        defectData = results.data;
        populateDefects();
      }
    });

    function populateModels() {
      const brand = document.getElementById("brand").value;
      const modelSelect = document.getElementById("model");
      const storageSelect = document.getElementById("storage");

      modelSelect.innerHTML = "";
      storageSelect.innerHTML = "";

      const models = [...new Set(priceData
        .filter(row => row.Marke === brand)
        .map(row => row.Modell))];

      models.forEach(model => {
        const opt = document.createElement("option");
        opt.value = model;
        opt.textContent = model;
        modelSelect.appendChild(opt);
      });

      if (models.length > 0) {
        populateStorages();
        modelSelect.onchange = populateStorages;
      }
    }

    function populateStorages() {
      const brand = document.getElementById("brand").value;
      const model = document.getElementById("model").value;
      const storageSelect = document.getElementById("storage");
      storageSelect.innerHTML = "";

      const storages = [...new Set(priceData
        .filter(row => row.Marke === brand && row.Modell === model)
        .map(row => row.Speicher))];

      storages.forEach(storage => {
        const opt = document.createElement("option");
        opt.value = storage;
        opt.textContent = storage + " GB";
        storageSelect.appendChild(opt);
      });
    }

    function populateDefects() {
      const container = document.getElementById("defectList");
      container.innerHTML = "<strong>Defekte Komponenten:</strong><br>";
      defectData.forEach(def => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" value="${def.Abzug}" class="defect"> ${def.Komponente}`;
        container.appendChild(label);
      });
    }

    function calculatePrice() {
      const brand = document.getElementById("brand").value;
      const model = document.getElementById("model").value;
      const storage = document.getElementById("storage").value;
      const multiplier = parseFloat(document.getElementById("condition").value);

      const entry = priceData.find(row =>
        row.Marke === brand &&
        row.Modell === model &&
        row.Speicher === storage);

      if (!entry) {
        document.getElementById("priceResult").textContent = "Kein Preis gefunden.";
        return;
      }

      let basePrice = parseFloat(entry.Basispreis);
      let finalPrice = Math.round(basePrice * multiplier);

      const defects = document.querySelectorAll(".defect:checked");
      let totalDefects = 0;
      defects.forEach(d => {
        totalDefects += parseFloat(d.value);
      });

      finalPrice -= totalDefects;
      if (finalPrice < 0) finalPrice = 0;

      document.getElementById("priceResult").textContent =
        `Ankaufspreis: CHF ${finalPrice}`;
    }
  </script>
</body>
</html>
